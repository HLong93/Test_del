# Dify 图文问答机器人工作流使用说明（修复版）

## 🚨 重要更新

由于原始工作流配置存在格式问题，我已经创建了修复版本。请使用以下修复后的文件：

- ✅ `基础版_图文问答机器人_修复版.yml`
- ✅ `进阶版_智能多模态助手_修复版.yml`
- ✅ `高级版_企业级可扩展问答系统_修复版.yml`

## 修复内容

### 1. 节点ID格式修复
- 使用数字字符串ID（如 `'1752659131948'`）而非描述性名称
- 确保所有节点ID在边连接中正确引用

### 2. 边连接修复
- 修正边的ID格式和命名规范
- 添加必需的 `zIndex` 和 `isInIteration` 属性
- 确保 `sourceHandle` 和 `targetHandle` 正确设置

### 3. 节点属性完善
- 添加 `sourcePosition` 和 `targetPosition` 属性
- 确保所有节点包含正确的位置信息
- 修复提示词模板的 `edition_type` 属性

### 4. 变量引用修复
- 修正所有变量选择器的引用格式
- 确保节点间数据传递的正确性

## 工作流版本对比

### 基础版 - 图文问答机器人（修复版）

**文件**: `基础版_图文问答机器人_修复版.yml`

**节点流程**:
```
开始(1752659131948) → 文档提取器(1752659131949) → 问题分类(1752659131950) 
→ 知识检索(1752659371747) → 回答生成(1752659389172) → 直接回复(answer)
```

**主要特性**:
- ✅ 支持文本、图片、文档输入
- ✅ 智能问题分类（5个类别）
- ✅ 知识库检索和重排序
- ✅ 图文混排输出
- ✅ 语音转文本支持

**配置要点**:
- 需要配置知识库ID：`fcf795ab-5d89-4640-b275-a2d77e2f11d3`
- 使用 `qwen-vl-max` 模型支持视觉理解
- 支持最多10个文件上传

### 进阶版 - 智能多模态助手（修复版）

**文件**: `进阶版_智能多模态助手_修复版.yml`

**节点流程**:
```
开始(1752659131948) → 文档提取器(1752659131949) → 智能问题分类(1752659131950) 
→ 条件分支(1752659131951) ┬─ 知识检索(1752659371747) ─┐
                          └─ 工具调用(1752659131952) ─┤
                                                    ↓
变量聚合(1752659131953) → 最终回答生成(1752659389172) → 直接回复(answer)
```

**主要特性**:
- ✅ 7种问题分类类型
- ✅ 条件分支逻辑处理
- ✅ 内置工具调用（web_scraper）
- ✅ 变量聚合处理
- ✅ 敏感词过滤
- ✅ 支持15个文件上传

**新增功能**:
- 智能条件分支判断
- 多数据源结果聚合
- 工具调用集成

### 高级版 - 企业级可扩展问答系统（修复版）

**文件**: `高级版_企业级可扩展问答系统_修复版.yml`

**节点流程**:
```
开始(1752659131948) → 文档提取器(1752659131949) → 企业级问题分类(1752659131950) 
→ 主要条件分支(1752659131951) ┬─ 主知识库检索(1752659371747) ─┐
                              └─ 专业知识库检索(1752659371748) ─┤
                                                              ↓
外部API调用(1752659131952) → 代码执行器(1752659131953) → 企业数据聚合(1752659131954) 
→ 企业级回答生成(1752659389172) → 直接回复(answer)
```

**主要特性**:
- ✅ 9种企业级问题分类
- ✅ 多知识库支持
- ✅ HTTP请求集成
- ✅ 自定义代码执行
- ✅ 企业级数据聚合
- ✅ 会话变量和环境变量
- ✅ 支持50个文件批量上传

**企业级功能**:
- 复杂业务逻辑处理
- 外部API集成
- 自定义Python代码执行
- 多层级数据聚合
- 企业安全控制

## 部署步骤

### 1. 导入工作流

1. 登录Dify管理界面
2. 进入"工作流"页面
3. 点击"导入"按钮
4. 选择对应的**修复版**YML文件
5. 确认导入成功

### 2. 配置知识库

**重要**：需要将知识库ID替换为您实际的知识库ID

在工作流中找到 `dataset_ids` 配置：
```yaml
dataset_ids:
- fcf795ab-5d89-4640-b275-a2d77e2f11d3  # 替换为您的知识库ID
- 49b4d49c-03c3-4050-9e0d-52ca722b55c9  # 可选：第二个知识库ID
```

### 3. 模型配置验证

确保以下模型在您的Dify实例中可用：
- **文本理解**: `qwen-turbo` / `qwen-max`
- **视觉理解**: `qwen-vl-max`
- **重排序**: `gte-rerank`

### 4. 环境变量配置（高级版）

对于高级版工作流，需要配置环境变量：
```yaml
environment_variables:
- id: api_base_url
  name: API基础URL
  value: 'https://your-api-endpoint.com'  # 替换为实际API地址
```

## 测试验证

### 基础测试
1. 上传一个PDF文档
2. 输入问题："这个文档的主要内容是什么？"
3. 验证是否返回图文混排的回答

### 进阶测试
1. 上传多个不同格式的文件
2. 测试条件分支是否正确工作
3. 验证工具调用功能

### 高级测试
1. 测试批量文件处理
2. 验证外部API调用
3. 检查代码执行器功能

## 常见问题解决

### Q1: 导入时仍然出现400错误
**A**: 请确保：
- 使用修复版文件
- 知识库ID已正确配置
- 模型名称在您的实例中可用

### Q2: 节点连接显示错误
**A**: 检查：
- 所有节点ID是否为字符串格式
- 边连接的source和target是否匹配
- 变量选择器引用是否正确

### Q3: 知识检索无结果
**A**: 验证：
- 知识库ID是否正确
- 知识库是否已完成向量化
- 检索参数是否合理

## 技术支持

如果遇到问题：
1. 检查Dify控制台的错误日志
2. 验证所有配置项是否正确
3. 参考Dify官方文档
4. 联系技术支持团队

## 更新日志

- **v1.1 (修复版)**: 
  - 修复节点ID格式问题
  - 修正边连接配置
  - 完善节点属性
  - 修复变量引用错误
  - 简化高级版复杂度
  - 添加详细的配置说明

---

**重要提醒**: 请务必使用修复版文件，原始版本存在格式问题无法正常导入。
